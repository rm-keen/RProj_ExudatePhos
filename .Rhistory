emm <- emmeans(mod, ~ Horizon)
pairs(emm, adjust = "tukey")
mod <- lmer(log(MA_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
anova(mod)
#lmm.check(mod)
emm <- emmeans(mod, ~ Horizon)
pairs(emm, adjust = "tukey")
mod <- lmer(log(AP_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
anova(mod)
lmm.check(mod)
emm <- emmeans(mod, ~ Horizon)
pairs(emm, adjust = "tukey")
mod <- lmer(log(AP_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
anova(mod)
#lmm.check(mod)
emm <- emmeans(mod, ~ Horizon)
pairs(emm, adjust = "tukey")
library(tidyverse)
library(here)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
options(contrasts = c("contr.sum","contr.poly"))
horizon_sub <- read_rds(here("data_intermediate", "horizon_sub.rds"))
print(horizon_sub)
horizon_sub <- read_rds(here("data_intermediate", "horizon_sub.rds"))
#print(horizon_sub)
horizon_sub$Location_knzmerge = "XX"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Calhoun"] <- "Calhoun"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Coal Creek"] <- "Coal Creek"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Reynolds Creek"] <- "Reynolds Creek"
horizon_sub$Location_knzmerge[horizon_sub$Location == "EKS"] <- "EKS"
horizon_sub$Location_knzmerge[horizon_sub$Location == "HAY"] <- "HAY"
horizon_sub$Location_knzmerge[horizon_sub$Location %in% c("Konza", "KNZ")] <- "Konza"
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
MAP_seq <- data.frame(MAP = seq(min(site_dat$MAP),
max(site_dat$MAP),
length.out = 200))
pred_A <- predict(mod_site,
newdata = MAP_seq,
se.fit = TRUE)
MAP_seq$fit <- exp(pred_A$fit) - 0.001
MAP_seq$lower <- exp(pred_A$fit - 1.96 * pred_A$se.fit) - 0.001
MAP_seq$upper <- exp(pred_A$fit + 1.96 * pred_A$se.fit) - 0.001
# grab raw profile-level data:
raw_A <- horizon_sub %>%
filter(Horizon == "A") %>%
mutate(eff_pct = AP_Efficiency * 100)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
p = ggplot(subset(horizon_sub, Horizon %in% c("A", "B")),
aes(MAP, AP_Efficiency)) +
theme_bw() + geom_jitter(aes(color = Horizon), size = 2, alpha = 0.9) +
# back-transformed trendline
geom_line(data = MAP_seq, aes(x = MAP, y = fit),
color = "#C2DA86", linetype = 'dotted', size = 0.7) +
theme(axis.title = element_text(size = 12),
axis.text = element_text(size = 11, color = "black"),
panel.grid = element_line(color = 'white'),
legend.position = 'none') +
labs(y = "AP efficiency (%)", color = " ") +
scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +
scale_color_manual(values = c("#C2DA86", "#2C3E6C"));p
ggsave("MAP_AP.png", p, height = 2.25, width = 2.61, dpi = 500)
# site-mean model
site_means_A <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_sitemean <- lm(mean_log ~ MAP, data = site_means_A)
summary(mod_sitemean)
Anova(mod_sitemean)
MAP_seq <- data.frame(MAP = seq(min(site_means_A$MAP),
max(site_means_A$MAP),
length.out = 200))
pred_A <- predict(mod_sitemean,
newdata = MAP_seq,
se.fit = TRUE)
MAP_seq$fit <- exp(pred_A$fit) - 0.001
MAP_seq$lower <- exp(pred_A$fit - 1.96 * pred_A$se.fit) - 0.001
MAP_seq$upper <- exp(pred_A$fit + 1.96 * pred_A$se.fit) - 0.001
# grab raw profile-level data:
raw_A <- horizon_sub %>%
filter(Horizon == "A") %>%
mutate(eff_pct = MA_Efficiency * 100)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
MAT_seq <- data.frame(MAT = seq(min(site_dat$MAT),
max(site_dat$MAT),
length.out = 200))
pred_A <- predict(mod_site,
newdata = MAT_seq,
se.fit = TRUE)
MAT_seq$fit <- exp(pred_A$fit) - 0.001
MAT_seq$lower <- exp(pred_A$fit - 1.96 * pred_A$se.fit) - 0.001
MAT_seq$upper <- exp(pred_A$fit + 1.96 * pred_A$se.fit) - 0.001
# grab raw profile-level data:
raw_A <- horizon_sub %>%
filter(Horizon == "A") %>%
mutate(eff_pct = AP_Efficiency * 100)
p = ggplot(subset(horizon_sub, Horizon %in% c("A", "B")),
aes(MAT, AP_Efficiency)) +
theme_bw() + geom_jitter(aes(color = Horizon), size = 2, alpha = 0.9) +
# back-transformed trendline
geom_line(data = MAT_seq, aes(x = MAT, y = fit),
color = "#C2DA86", linetype = 'longdash', size = 0.7) +
theme(axis.title = element_text(size = 12),
axis.text = element_text(size = 11, color = "black"),
panel.grid = element_line(color = 'white'),
legend.position = 'none') +
labs(y = "AP efficiency (%)", color = " ") +
scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +
scale_color_manual(values = c("#C2DA86", "#2C3E6C"));p
ggsave("MAT_AP.png", p, height = 2.25, width = 2.61, dpi = 500)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
MAT_seq <- data.frame(MAT = seq(min(site_dat$MAT),
max(site_dat$MAT),
length.out = 200))
pred_A <- predict(mod_site,
newdata = MAT_seq,
se.fit = TRUE)
MAT_seq$fit <- exp(pred_A$fit) - 0.001
MAT_seq$lower <- exp(pred_A$fit - 1.96 * pred_A$se.fit) - 0.001
MAT_seq$upper <- exp(pred_A$fit + 1.96 * pred_A$se.fit) - 0.001
# grab raw profile-level data:
raw_A <- horizon_sub %>%
filter(Horizon == "A") %>%
mutate(eff_pct = MA_Efficiency * 100)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
p = ggplot(subset(horizon_sub, Horizon %in% c("A", "B")),
aes(MAT, OA_Efficiency)) +
theme_bw() + geom_jitter(aes(color = Horizon), size = 2, alpha = 0.9) +
theme(axis.title = element_text(size = 12),
axis.text = element_text(size = 11, color = "black"),
panel.grid = element_line(color = 'white'),
legend.position = 'none') +
labs(y = "OA efficiency (%)", color = " ") +
scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +
scale_color_manual(values = c("#C2DA86", "#2C3E6C"));p
ggsave("MAT_OA.png", p, height = 2.25, width = 2.53, dpi = 500)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_means_A <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_sitemean <- lm(mean_log ~ MAP, data = site_means_A)
summary(mod_sitemean)
Anova(mod_sitemean)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAP = unique(MAP)
)
mod_site <- lm(mean_log ~ MAP, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(AP_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(MA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "A") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
# site-mean model
site_dat <- horizon_sub |>
dplyr::filter(Horizon == "B") |>
dplyr::group_by(Location_knzmerge) |>
dplyr::summarise(
mean_log = mean(log(OA_Efficiency + 0.001), na.rm = TRUE),
MAT = unique(MAT)
)
mod_site <- lm(mean_log ~ MAT, data = site_dat)
summary(mod_site)
Anova(mod_site)
options(contrasts = c("contr.sum","contr.poly"))
horizon_sub <- read_rds(here("data_intermediate", "horizon_sub.rds"))
lmm.check <- function(mod) {
par(mfrow = c(1, 3))
# 1. Residuals vs Fitted
plot(fitted(mod), resid(mod),
main = " ", xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "darkred", lwd = 2, lty = 2)
# 2. Histogram of residuals
hist(residuals(mod), main = " ", xlab = expression(hat(epsilon)))
abline(v = 0, col = "darkred", lwd = 2)
# 3. Q-Q plot
qqnorm(residuals(mod), main = " ")
qqline(residuals(mod), col = "darkred", lwd = 2)
}
# combine konza sites
horizon_sub$Location_knzmerge = "XX"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Calhoun"] <- "Calhoun"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Coal Creek"] <- "Coal Creek"
horizon_sub$Location_knzmerge[horizon_sub$Location == "Reynolds Creek"] <- "Reynolds Creek"
horizon_sub$Location_knzmerge[horizon_sub$Location == "EKS"] <- "EKS"
horizon_sub$Location_knzmerge[horizon_sub$Location == "HAY"] <- "HAY"
horizon_sub$Location_knzmerge[horizon_sub$Location %in% c("Konza", "KNZ")] <- "Konza"
h_means_oa <- horizon_sub %>%
mutate(
Eff_pct_oa = OA_Efficiency * 100
) %>%
group_by(HorizonFlip) %>%
summarise(
mean_eff = mean(Eff_pct_oa, na.rm = TRUE),
sd_eff = sd(Eff_pct_oa, na.rm = TRUE),
se_eff   = sd(Eff_pct_oa, na.rm = TRUE) / sqrt(dplyr::n()),
.groups = "drop"
) %>%
mutate(h_num = as.numeric(HorizonFlip))
h_means_ma <- horizon_sub %>%
mutate(
Eff_pct_ma = MA_Efficiency * 100
) %>%
group_by(HorizonFlip) %>%
summarise(
mean_eff = mean(Eff_pct_ma, na.rm = TRUE),
sd_eff = sd(Eff_pct_ma, na.rm = TRUE),
se_eff   = sd(Eff_pct_ma, na.rm = TRUE) / sqrt(dplyr::n()),
.groups = "drop"
) %>%
mutate(h_num = as.numeric(HorizonFlip))
h_means_ap <- horizon_sub %>%
mutate(
Eff_pct_ap = AP_Efficiency * 100
) %>%
group_by(HorizonFlip) %>%
summarise(
mean_eff = mean(Eff_pct_ap, na.rm = TRUE),
sd_eff = sd(Eff_pct_ap, na.rm = TRUE),
se_eff   = sd(Eff_pct_ap, na.rm = TRUE) / sqrt(dplyr::n()),
.groups = "drop"
) %>%
mutate(h_num = as.numeric(HorizonFlip))
p1 = ggplot() + theme_bw() + coord_flip() +
geom_jitter(data = horizon_sub, size = 2, alpha = 0.8,
aes(HorizonFlip, y = OA_Efficiency*100, color = Location_knzmerge),
width = 0.1, height = 0.1) +
geom_pointrange(data = h_means_oa, aes(x = h_num, y = mean_eff,
ymin = mean_eff - se_eff,
ymax = mean_eff + se_eff),
color = "black", size = 0.8, pch = 17) +
geom_line(data = h_means_oa, aes(x = h_num, y = mean_eff),
color = "black", alpha = 0.6) +
scale_color_manual(values = c("#BFBFBF", "#2C3E6C", "#C2DA86", "#E2A97E", "#B93E25", "#91BFDB")) +
theme(axis.text.x = element_text(size = 11, color = "black"),
axis.text.y = element_text(size = 11, color = "black"),
axis.title.y = element_text(size = 12.5, margin = margin(r = 11.5)),
axis.title.x = element_text(size = 12.5),
plot.title = element_text(size = 11, face = "bold"),
panel.grid = element_line(color = 'white'),
panel.grid.major.y = element_line(color = 'gray97'),
strip.text = element_text(size = 10.5),
strip.background = element_blank()) +
labs(y = "P extraction efficiency (%)", x = "Horizon", title = "Oxalic acid")
p2 = ggplot() + theme_bw() + coord_flip() +
geom_jitter(data = horizon_sub, size = 2, alpha = 0.8,
aes(HorizonFlip, y = MA_Efficiency*100, color = Location_knzmerge),
width = 0.1, height = 0.1) +
geom_pointrange(data = h_means_ma, aes(x = h_num, y = mean_eff,
ymin = mean_eff - se_eff,
ymax = mean_eff + se_eff),
color = "black", size = 0.8, pch = 17) +
geom_line(data = h_means_ma, aes(x = h_num, y = mean_eff),
color = "black", alpha = 0.6) +
scale_color_manual(values = c("#BFBFBF", "#2C3E6C", "#C2DA86", "#E2A97E", "#B93E25", "#91BFDB")) +
theme(axis.text.x = element_text(size = 11, color = "black"),
axis.text.y = element_text(size = 11, color = "black"),
axis.title.y = element_text(size = 12.5, margin = margin(r = 11.5)),
axis.title.x = element_text(size = 12.5),
plot.title = element_text(size = 11, face = "bold"),
panel.grid = element_line(color = 'white'),
panel.grid.major.y = element_line(color = 'gray97'),
strip.text = element_text(size = 10.5),
strip.background = element_blank()) +
labs(y = "P extraction efficiency (%)", x = "Horizon", title = "Malic acid")
p3 = ggplot() + theme_bw() + coord_flip() +
geom_jitter(data = horizon_sub, size = 2, alpha = 0.8,
aes(HorizonFlip, y = AP_Efficiency*100, color = Location_knzmerge),
width = 0.1, height = 0.1) +
geom_pointrange(data = h_means_ap, aes(x = h_num, y = mean_eff,
ymin = mean_eff - se_eff,
ymax = mean_eff + se_eff),
color = "black", size = 0.8, pch = 17) +
geom_line(data = h_means_ap, aes(x = h_num, y = mean_eff),
color = "black", alpha = 0.6) +
scale_color_manual(values = c("#BFBFBF", "#2C3E6C", "#C2DA86", "#E2A97E", "#B93E25", "#91BFDB")) +
theme(axis.text.x = element_text(size = 11, color = "black"),
axis.text.y = element_text(size = 11, color = "black"),
axis.title.y = element_text(size = 12.5, margin = margin(r = 11.5)),
axis.title.x = element_text(size = 12.5),
plot.title = element_text(size = 11, face = "bold"),
panel.grid = element_line(color = 'white'),
panel.grid.major.y = element_line(color = 'gray97'),
strip.text = element_text(size = 10.5),
strip.background = element_blank()) +
labs(y = "P extraction efficiency (%)", x = "Horizon", title = "APase")
plot = ggarrange(p1, p2, p3, nrow = 1, common.legend = T);plot
mod <- lmer(log(OA_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
anova(mod)
#lmm.check(mod)
summary(mod)
anova(mod)
Anova(mod, type = 3)
mod <- lmer(log(OA_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
anova(mod)
Anova(mod, type = 3)
#lmm.check(mod)
mod <- lmer(log(OA_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
Anova(mod, type = 3)
mod <- lmer(log(MA_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
Anova(mod, type = 3)
mod <- lmer(log(AP_Efficiency + 0.001) ~ Horizon + (1 | Location_knzmerge / ProfileID),
data = horizon_sub)
summary(mod)
Anova(mod, type = 3)
