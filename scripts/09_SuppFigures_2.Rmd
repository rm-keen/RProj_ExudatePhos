---
title: "09_SuppFigures_2"
output: html_document
date: "2025-10-13"
---

```{r}
library(tidyverse)
library(here)
library(ggpubr)
library(lmerTest)
library(car)
library(emmeans)
```

Set contrasts
```{r message = FALSE, warning = FALSE}
options(contrasts = c("contr.sum","contr.poly"))
```


# 1 - Load data files
```{r}
horizon_sub <- read_rds(here("data_intermediate", "horizon_sub.rds"))
print(horizon_sub)
```


-----------------------


# 2 - Model prep
Function to plot model diagnostics
```{r}
lmm.check <- function(mod) {
  par(mfrow = c(1, 3))
  # 1. Residuals vs Fitted
    plot(fitted(mod), resid(mod),
        main = " ", xlab = "Fitted Values", ylab = "Residuals")
    abline(h = 0, col = "darkred", lwd = 2, lty = 2)
  # 2. Histogram of residuals
    hist(residuals(mod), main = " ", xlab = expression(hat(epsilon)))
    abline(v = 0, col = "darkred", lwd = 2)
  # 3. Q-Q plot
    qqnorm(residuals(mod), main = " ")
    qqline(residuals(mod), col = "darkred", lwd = 2)
}
```

Log transformed response and predictor variables for models
```{r}
# Rename 'PercC' as 'SOC'
horizon_sub$SOC = horizon_sub$PercC

horizon_sub$log_AP_OA = log(horizon_sub$AP_OA + 0.001)
horizon_sub$log_MA_OA = log(horizon_sub$MA_OA + 0.001)
horizon_sub$log_AP_MA = log(horizon_sub$AP_MA + 0.001)

horizon_sub$logpH = log(horizon_sub$pH + 0.001)
horizon_sub$logSOC = log(horizon_sub$SOC + 0.001)
horizon_sub$logRootBio = log(horizon_sub$RootBio + 0.001)
```


-----------------------


# 3 - AP:OA panels & LMMs
## pH
A horizon
```{r fig.height=2.75, fig.width=8}
mod.A = lmer(log(AP_OA+0.001) ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r fig.height=2.75, fig.width=8}
mod.B = lmer(log_AP_OA ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
# Create a sequence of pH values that covers range in plots
new_pH <- data.frame(pH = seq(min(horizon_sub$pH, na.rm = T),
                              max(horizon_sub$pH, na.rm = T), 
                              length.out = 100))
# Predict for A horizon
new_A <- new_pH %>%
  mutate(pred_log = predict(mod.A, newdata = ., re.form = NA),
         pred = exp(pred_log) - 0.001, ## account for offset used during log transformation
         Horizon = "A")

# Plot w/ back-transformed trend lines 
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(pH, AP_OA)) + 
  geom_line(data = new_A, aes(x = pH, y = pred, color = Horizon), size = 0.7) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +  ylim(0,0.7) +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C"))
```


## SOC
```{r fig.height=2.75, fig.width=8}
## A horizon
mod.A = lmer(log(AP_OA+0.001) ~ SOC + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r fig.height=2.75, fig.width=8}
mod.B = lmer(log(AP_OA+0.001) ~ SOC + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
############# A horizon ####################################
# Create a sequence of pH values that covers range in plots
new_SOC_A <- data.frame(SOC = seq(min(subset(horizon_sub, Horizon == "A")$SOC, na.rm = T),
                              max(subset(horizon_sub, Horizon == "A")$SOC, na.rm = T), 
                              length.out = 100))
# Predict for A horizon
new_A <- new_SOC_A %>%
  mutate(pred_log = predict(mod.A, newdata = ., re.form = NA),
         pred = exp(pred_log) - 0.001, ## account for offset used during log transformation
         Horizon = "A")

############# B horizon ####################################
# Create a sequence of pH values that covers range in plots
new_SOC_B <- data.frame(SOC = seq(min(subset(horizon_sub, Horizon == "B")$SOC, na.rm = T),
                              max(subset(horizon_sub, Horizon == "B")$SOC, na.rm = T), 
                              length.out = 100))
# Predict for B horizon
new_B <- new_SOC_B %>%
  mutate(pred_log = predict(mod.B, newdata = ., re.form = NA),
         pred = exp(pred_log) - 0.001, ## account for offset used during log transformation
         Horizon = "A")

# Plot w/ back-transformed trendlines for both horizons
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(SOC, AP_OA)) + 
  geom_line(data = new_A, aes(x = SOC, y = pred), color = "#C2DA86", size = 0.7) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  geom_line(data = new_B, aes(x = SOC, y = pred), size = 0.7, color = '#2C3E6C') +
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') +  ylim(0,0.7) +
  labs(color = " ") +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C"))
```


## Roots
A horizon
```{r fig.height=2.75, fig.width=8}
mod.A = lmer(log_AP_OA ~ logRootBio + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r fig.height=2.75, fig.width=8}
mod.B = lmer(log_AP_OA ~ logRootBio + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
offset_x <- 0.001;offset_y <- 0.001

# Create a sequence of SOC values that covers range in plots
new_root <- data.frame(RootBio = seq(min(subset(horizon_sub, Horizon %in% c("A", "B"))$RootBio, na.rm = TRUE),
                                max(subset(horizon_sub, Horizon %in% c("A", "B"))$RootBio, na.rm = TRUE),
                                length.out = 100))
# Predict for A horizon
new_root$logRootBio <- log(new_root$RootBio + offset_x) ## add log_SOC column
new_root$pred_log <- predict(mod.A, newdata = new_root, re.form = NA) ## predict on log-log scale
new_root$pred_AP_OA <- exp(new_root$pred_log) - offset_y ## back-transform
new_root$Horizon <- "A" ## label horizon

## no relationship in B horizon

# Plot w/ back-transformed trend lines
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(RootBio, AP_OA)) + 
  geom_line(data = new_root, aes(x = RootBio, y = pred_AP_OA, linetype = Horizon), 
            color = "#C2DA86", size = 0.7) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C")) + ylim(0,0.7) +
  scale_linetype_manual(values = c(1,2))
```


# 4 - MA:OA panels & LMMs
## pH
A horizon
```{r}
mod.A = lmer(log_MA_OA ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(MA_OA ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(pH, MA_OA)) + 
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C")) + ylim(0,1.4) +
  scale_linetype_manual(values = c(1,2))
```


## SOC
A horizon
```{r}
mod.A = lmer(log_MA_OA ~ logSOC + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(MA_OA ~ log(SOC+0.001) + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
############### A Horizon (log-log) ########################################
offset_x <- 0.001;offset_y <- 0.001

# Create a sequence of SOC values that covers range in plots
new_SOC <- data.frame(SOC = seq(min(subset(horizon_sub, Horizon %in% c("A"))$SOC, na.rm = TRUE),
                                max(subset(horizon_sub, Horizon %in% c("A"))$SOC, na.rm = TRUE),
                                length.out = 100))
# Predict for A horizon
new_SOC$logSOC <- log(new_SOC$SOC + offset_x) ## add log_SOC column
new_SOC$pred_log <- predict(mod.A, newdata = new_SOC, re.form = NA) ## predict on log-log scale
new_SOC$pred_MA_OA <- exp(new_SOC$pred_log) - offset_y ## back-transform
new_SOC$Horizon <- "A" ## label horizon

############### B Horizon (log(predictor)) ########################################
offset_x <- 0.001
b0_B <- fixef(mod.B)[1]
b1_B <- fixef(mod.B)[2]

trend_line <- data.frame(SOC = seq(min(subset(horizon_sub, Horizon %in% c("B"))$SOC, na.rm = TRUE),
                                max(subset(horizon_sub, Horizon %in% c("B"))$SOC, na.rm = TRUE),
                                length.out = 100)) %>%
  mutate(pred = b0_B + b1_B * log(SOC + offset_x))

# Plot w/ back-transformed trendlines
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(SOC, MA_OA)) + 
  geom_line(data = new_SOC, aes(x = SOC, y = pred_MA_OA), color = "#C2DA86", size = 0.7) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) +
  geom_line(data = trend_line, aes(x = SOC, y = pred), color = "#2C3E6C", size = 0.7) +
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(y = "AP efficiency (%)", color = " ") +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C")) +  ylim(0,1.4) +
  scale_linetype_manual(values = c(1,2))
```


## Roots
A horizon
```{r}
mod.A = lmer(MA_OA ~ RootBio + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(MA_OA ~ log(RootBio+0.001) + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.6, warning = FALSE}
######################### A horizon (linear) ####################
f.a = fixef(mod.A)
int.a = f.a[1]
slo.a = f.a[2]

## A horizon equation:
## y = 0.0353x + 0.282

######################### B horizon (log(predictor)) ###########
offset_x <- 0.001
b0_B <- fixef(mod.B)[1]
b1_B <- fixef(mod.B)[2]

trend_line <- data.frame(RootBio = seq(min(subset(horizon_sub, Horizon %in% c("B"))$RootBio, na.rm = TRUE),
                                   max(subset(horizon_sub, Horizon %in% c("B"))$RootBio, na.rm = TRUE),
                                   length.out = 100)) %>%
  mutate(pred = b0_B + b1_B * log(RootBio + offset_x))

## Check equation:
predict(mod.B, newdata = data.frame(RootBio = 10), re.form = NA) ## 0.4560689  
b0_B  + b1_B * log(10+0.001) ## 0.4560689 

## Equation: 0.262 + 0.084 * log(x)

################################################################
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(RootBio, MA_OA)) + 
  geom_smooth(data = subset(horizon_sub, Horizon %in% c("A")),
              method = 'lm', se = F, size = 0.7, color = "#C2DA86") +
  geom_line(data = trend_line, aes(x = RootBio, y = pred), color = "#2C3E6C", size = 0.7) +
  #geom_abline(slope = slo.a, intercept = int.a, color = 'green', size = 0.7, linetype = 2) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +  ylim(0,1.4) +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C"))
```



# 5 - AP:MA panels & LMMs
## pH
A horizon
```{r}
mod.A = lmer(AP_MA ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(log_AP_MA ~ pH + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.69, warning = FALSE}
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(pH, AP_MA)) + 
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C")) + ylim(0,0.92) +
  scale_linetype_manual(values = c(1,2))
```


## SOC
A horizon
```{r}
mod.A = lmer(AP_MA ~ SOC + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(log_AP_MA ~ SOC + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.69, warning = FALSE}
f.a = fixef(mod.A)
int.a = f.a[1]
slo.a = f.a[2]

## A horizon equation:
## y = 0.0619x + 0.09337

ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(SOC, AP_MA)) + 
  geom_smooth(data = subset(horizon_sub, Horizon %in% c("A")),
              method = 'lm', se = F, size = 0.7, color = '#C2DA86') +
  #geom_abline(slope = slo.a, intercept = int.a, color = 'green', size = 0.7, linetype = 2) +
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +  ylim(0,0.92) +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C"))
```


## Roots
A horizon
```{r}
mod.A = lmer(log_AP_MA ~ RootBio + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

B horizon
```{r}
mod.B = lmer(log_AP_MA ~ RootBio + (1|SiteID), data = subset(horizon_sub, Horizon %in% c("B")))
Anova(mod.B, type = 3)
#lmm.check(mod.B)
```

```{r fig.height=2.25, fig.width=2.69, warning = FALSE}
ggplot(subset(horizon_sub, Horizon %in% c("A", "B")), 
                 aes(RootBio, AP_MA)) + 
  theme_bw() + geom_point(aes(color = Horizon), size = 2, alpha = 0.9) + 
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 11, color = "black"),
        panel.grid = element_line(color = 'white'),
        legend.position = 'none') + 
  labs(color = " ") +
  scale_fill_manual(values = c("#C2DA86", "#2C3E6C")) +  ylim(0,0.92) +
  scale_color_manual(values = c("#C2DA86", "#2C3E6C"))
```


-----------------------


# 6 - SOC outlier
Re-running models after removing potential SOC outlier

Remove Calhoun outlier:
```{r}
horizon_sub_out = subset(horizon_sub, Horizon %in% c("A", "B") & PercC < 6)
```

## AP:OA
A horizon
```{r}
mod.A = lmer(log(AP_OA+0.001) ~ SOC + (1|SiteID), data = subset(horizon_sub_out, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```

## MA:OA
A horizon
```{r}
mod.A = lmer(log_MA_OA ~ logSOC + (1|SiteID), data = subset(horizon_sub_out, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```


## AP:MA 
A horizon
```{r}
mod.A = lmer(AP_MA ~ SOC + (1|SiteID), data = subset(horizon_sub_out, Horizon %in% c("A")))
Anova(mod.A, type = 3)
#lmm.check(mod.A)
```














