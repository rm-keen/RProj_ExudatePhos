---
title: "01_DataPrep"
output: html_document
date: "2025-10-13"
---

```{r}
library(tidyverse)
library(here)
```

# 1 - Load data files
```{r}
AllData <- read_csv(here("data_inputs/ExudateProj_Full.csv"))
print(AllData)

# Save AllData as intermediate data object
write_rds(AllData, here("data_intermediate", "AllData.rds"))
```

# 2 - Calculate efficiency ratios
```{r}
ratio_calc = subset(AllData, select = c('Location', 'SiteID','ProfileID','MidDepth','Horizon', 'DomVeg', 
                                        'Extractant', 'P_Efficiency', 'NatBiome', 'CoverType', 'Position', 
                                        'Lithology', 'SoilFormation', 'MAP', 'RootMass_mg_gsoil', 'pH', 
                                        'Soil_PercC', 'Soil_MgCg'))

# Set Extractant as a factor
ratio_calc$Extractant = as.factor(ratio_calc$Extractant)
levels(ratio_calc$Extractant) = c("AP", "MA", "OA") # AP = APase, MA = Malic Acid, OA = Oxalic Acid

# Put P_Efficiency data in wide format to calculate ratios
ratio_calc <- ratio_calc %>%
  pivot_wider(names_from = Extractant,
              values_from = P_Efficiency,
              names_prefix = "Efficiency_")

# Rename the columns for clarity
ratio_calc <- ratio_calc %>%
  rename(MA_Efficiency = "Efficiency_MA",
         OA_Efficiency = "Efficiency_OA",
         AP_Efficiency = "Efficiency_AP")

# Calculate efficiency ratios for each pair of exudates
ratio_calc$MA_OA = ratio_calc$MA_Efficiency / ratio_calc$OA_Efficiency
ratio_calc$AP_OA = ratio_calc$AP_Efficiency / ratio_calc$OA_Efficiency
ratio_calc$AP_MA = ratio_calc$AP_Efficiency / ratio_calc$MA_Efficiency

ratio_calc <- ratio_calc %>%
  ungroup() %>%
  mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))
```

# 3 - Calculate horizon averages
```{r message = FALSE}
horizon_sub = ratio_calc %>%
  group_by(Location, SiteID, ProfileID, Horizon, DomVeg, NatBiome, 
           CoverType, Position, Lithology, SoilFormation, MAP) %>%
  summarise(RootBio = mean(RootMass_mg_gsoil, na.rm = T),   
            Soil_MgCg = mean(Soil_MgCg, na.rm = T),      
            pH = mean(pH, na.rm = T), 
            AP_Efficiency = mean(AP_Efficiency, na.rm = T), 
            MA_Efficiency = mean(MA_Efficiency, na.rm = T), 
            OA_Efficiency = mean(OA_Efficiency, na.rm = T),
            MA_OA = mean(MA_OA, na.rm = T), 
            AP_OA = mean(AP_OA, na.rm = T), 
            AP_MA = mean(AP_MA, na.rm = T),
            PercC = mean(Soil_PercC, na.rm = T))      

horizon_sub <- horizon_sub %>%
  ungroup() %>%
  mutate(across(everything(), ~ ifelse(is.nan(.), NA, .)))

## Selecting O, A, B, and C horizons
horizon_sub = subset(horizon_sub, Horizon %in% c("O", "A", "B", "C"))
horizon_sub$Horizon = factor(horizon_sub$Horizon, levels = c("O", "A", "B", "C"))

## Remove infinite values caused by zero values in denominator of ratio calculations
horizon_sub[c('MA_OA')][sapply(horizon_sub[c('MA_OA')], is.infinite)] <- NA
horizon_sub[c('AP_OA')][sapply(horizon_sub[c('AP_OA')], is.infinite)] <- NA
```

# 4 - Log-transformations for models
```{r}
## log transformations with small offset to account for zero values
horizon_sub$log_OA_Efficiency = log(horizon_sub$OA_Efficiency + 0.01)
horizon_sub$log_MA_Efficiency = log(horizon_sub$MA_Efficiency + 0.01)
horizon_sub$log_AP_Efficiency = log(horizon_sub$AP_Efficiency + 0.01)

horizon_sub$log_AP_OA = log(horizon_sub$AP_OA + 0.01)
horizon_sub$log_MA_OA = log(horizon_sub$MA_OA + 0.01)
horizon_sub$log_AP_MA = log(horizon_sub$AP_MA + 0.01)
```

# 5 - Organize ecosystem / veg types, location labels, and horizon levels for plots
```{r}
## Ecosystem type column to separate out the crop profiles
horizon_sub$NewEcoType = "X"
horizon_sub$NewEcoType[horizon_sub$SiteID == "Calhoun (FRES)"] = "Temperate Forests"
horizon_sub$NewEcoType[horizon_sub$SiteID == "Coal Creek (FRES)"] = "Alpine Forests"
horizon_sub$NewEcoType[horizon_sub$SiteID == "Reynolds Creek (FRES)"] = "Shrublands"
horizon_sub$NewEcoType[horizon_sub$SiteID == "Konza (FRES)"] = "Grasslands"
horizon_sub$NewEcoType[horizon_sub$ProfileID %in% c("HAY-A", "EKS-A", "KNZ-A")] = "Croplands"
horizon_sub$NewEcoType[horizon_sub$ProfileID %in% c("HAY-N", "HAY-P", "EKS-N", "EKS-P", 
                                                    "KNZ-N", "KNZ-P")] = "Grasslands"
horizon_sub$NewEcoType = factor(horizon_sub$NewEcoType, 
                                levels = c("Alpine Forests", "Temperate Forests", "Shrublands",
                                           "Grasslands", "Croplands"))

## Cover type column to combine the same broad vegetation types
horizon_sub$NewVegType = "X"
horizon_sub$NewVegType[horizon_sub$CoverType %in% c("Hardwood", "Aspen")] = "Decid. tree"
horizon_sub$NewVegType[horizon_sub$CoverType %in% c("Pine", "Spruce", "Old cut juniper",
                                                    "Old live juniper", "Young cut juniper",
                                                    "Young live juniper")] = "Evergr. tree"
horizon_sub$NewVegType[horizon_sub$CoverType %in% c("Crop")] = "Crop"
horizon_sub$NewVegType[horizon_sub$ProfileID %in% c("HAY-N", "KNZ-N", "EKS-N")] = "Native Prairie"
horizon_sub$NewVegType[horizon_sub$ProfileID %in% c("HAY-P", "KNZ-P", "EKS-P",
                                                    "KZL1-C", "KZL1-S", "KZL2-C", "KZL2-S")] = "Regen. Prairie"
horizon_sub$NewVegType[horizon_sub$CoverType %in% c("Young live sage", "Old live sage")] = "Shrub"

## Combining 'Konza' and 'KNZ' locations into one ('Konza') in a new 'Location2' column
horizon_sub$Location2 = "XX"
horizon_sub$Location2[horizon_sub$Location == "Calhoun"] = "Calhoun, SC"
horizon_sub$Location2[horizon_sub$Location == "Coal Creek "] = "Coal Creek, CO"
horizon_sub$Location2[horizon_sub$Location == "EKS"] = "Ottawa, KS"
horizon_sub$Location2[horizon_sub$Location == "HAY"] = "Hays, KS"
horizon_sub$Location2[horizon_sub$Location == "Reynolds Creek "] = "Reynolds Creek, ID"
horizon_sub$Location2[horizon_sub$Location %in% c("Konza", "KNZ")] = "Konza Prairie, KS"

## Flip order of horizons and save as a new factor column
horizon_sub$HorizonFlip = factor(horizon_sub$Horizon, 
                                 levels = c("C", "B", "A", "O"))
```

Add mean annual temperature (MAT) data
```{r}
horizon_sub$MAT = 999
horizon_sub$MAT[horizon_sub$Location == "Calhoun"] = 16
horizon_sub$MAT[horizon_sub$Location == "Coal Creek"] = 1.8
horizon_sub$MAT[horizon_sub$Location == "Reynolds Creek"] = 7.8
horizon_sub$MAT[horizon_sub$Location == "HAY"] = 12.3
horizon_sub$MAT[horizon_sub$Location %in% c("KNZ", "Konza")] = 12.4
horizon_sub$MAT[horizon_sub$Location == "EKS"] = 13.2
```


# 6 - Save as intermediate data object
```{r}
write_rds(horizon_sub, here("data_intermediate", "horizon_sub.rds"))
```



